# Telegram Tarot Bot

## Настройка

1. Скопируйте файл окружения и укажите токен бота и имя канала:
   ```bash
   cp .env.example .env
   ```
   Заполните:
   - `BOT_TOKEN` — токен, выданный [BotFather](https://t.me/BotFather).
   - `CHANNEL_USERNAME` — имя канала без `@`, в котором бот является администратором.
   - `OPENAI_API_KEY` — ключ OpenAI (используется для интерпретаций карт; при отсутствии будут отправлены заглушки).
   - `LLM_ENABLED` — `1` чтобы включить GPT-интерпретации, `0` чтобы всегда возвращать текст заглушки и экономить запросы.
   - `LLM_MODEL` — модель OpenAI для интерпретаций (по умолчанию `gpt-4.1-mini`).
   - `LLM_SYSTEM_PROMPT` — system prompt для GPT (по умолчанию нейтральный стиль на русском, без пафоса).
   - `LLM_MAX_TOKENS_DAY` — лимит токенов в ответе GPT для расклада "Карта дня" (по умолчанию `220`).
   - `LLM_MAX_TOKENS_3` — лимит токенов для расклада "Расклад из 3 карт" (по умолчанию `420`).

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Добавьте карты Таро:
   - Положите изображения (форматы `png`, `jpg`, `jpeg`) в папку `assets/cards/`.
   - Для расклада из 3 карт нужно минимум 3 изображения.

## Запуск

Запустите бота в режиме polling:
```bash
python main.py
```

Доступные команды:
- `/start` — проверка подписки на канал и выдача бесплатного расклада при первой проверке.

Доступные кнопки:
- Inline: "Подписаться" (ссылка на канал), "Проверить подписку" для повторной проверки.
- Reply: "Меню" — показывает количество доступных раскладов, "Получить расклад" — открывает выбор действия.
- При отсутствии раскладов: "Premium" (заглушка) и "Пригласить друга" (отправляет персональную реферальную ссылку).
- При наличии раскладов: "Карта дня" (отправляет случайную карту с изображением и краткую интерпретацию) и "Расклад из 3 карт" (коллаж 1×3 из случайных карт с интерпретацией). Для расклада из 3 карт бот попросит вопрос и добавит кнопку "Отмена" для выхода без списания расклада.

## Реферальная система

- Кнопка "Пригласить друга" отправляет ссылку вида `https://t.me/<BOT_USERNAME>?start=<user_id>`.
- Если новый пользователь запускает бота по этой ссылке, приглашавшему начисляется +1 расклад и увеличивается счётчик приглашённых. Повторное начисление за того же пользователя не происходит.
- Бонусы хранятся вместе с остальными данными в `data/users.json`.

## Интерпретации карт

- "Карта дня" не требует вопроса: бот тянет случайную карту, отправляет изображение и короткую интерпретацию (5–7 предложений, нейтральный тон). При отключённом LLM (`LLM_ENABLED=0`) или недоступности OpenAI отправляется заглушка.
- "Расклад из 3 карт" требует вопроса: бот просит ввести вопрос, затем тянет 3 разные карты, отправляет коллаж и интерпретацию по каждой карте + общий вывод. Есть кнопка "Отмена" для возврата в меню без списания расклада. При ошибке OpenAI или отключённом LLM отправляется заглушка, но коллаж остаётся.

> Для проверки подписки бот должен быть администратором канала, указанного в `CHANNEL_USERNAME`.
